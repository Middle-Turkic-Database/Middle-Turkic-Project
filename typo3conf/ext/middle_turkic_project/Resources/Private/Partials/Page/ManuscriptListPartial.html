{namespace fl=Causal\FileList\ViewHelpers} {namespace xslt=Digicademy\CobjXslt\ViewHelpers}

<f:if condition="{f:cObject(typoscriptObjectPath:'lib.manuscriptArgument')}">
    <f:variable name="manuscriptArgument">
        <f:cObject typoscriptObjectPath="lib.manuscriptArgument" />
    </f:variable>
    {manuscriptArgument -> v:format.trim() -> f:variable(name:"manuscriptArgument")}
</f:if>

<f:if condition="{f:cObject(typoscriptObjectPath:'lib.manuscriptDescription')}">
    <f:variable name="manuscriptDescription">
        <f:cObject typoscriptObjectPath="lib.manuscriptDescription" />
    </f:variable>
</f:if>

<f:if condition="{f:cObject(typoscriptObjectPath:'lib.manuscriptNav')}">
    <f:variable name="manuscriptNav">
        <f:cObject typoscriptObjectPath="lib.manuscriptNav" />
    </f:variable>
    {manuscriptNav -> v:format.trim() -> f:variable(name:"manuscriptNav")}
</f:if>

<f:if condition="{f:cObject(typoscriptObjectPath:'lib.manuscriptPath')}">
    <f:variable name="manuscriptPath">
        <f:cObject typoscriptObjectPath="lib.manuscriptPath" />
    </f:variable>
    {manuscriptPath -> v:format.trim() -> f:variable(name:"manuscriptPath")}
</f:if>

<f:if condition="{manuscriptArgument}">
    <f:then>
        <v:media.exists file="{manuscriptPath}/{manuscriptArgument}.xml" then="{f:render(section:'manuscriptContentSection', arguments: '{_all}')}" else="{v:variable.set(value: '1', name: 'wrongManuscript')}{f:render(section:'manuscriptListSection', arguments='{_all}')}" />
    </f:then>
    <f:else>
        <f:render section="manuscriptListSection" arguments="{_all}" />
    </f:else>
</f:if>

<f:section name="manuscriptListSection">
    <f:if condition="{wrongManuscript}">
        <script src="{f:uri.resource(path:'JavaScript/Dist/manuscriptNotFound.js', extensionName: 'middle_turkic_project')}"></script>
    </f:if>
    <table id="dtManuscriptList" class="table table-responsive table-striped table-bordered table-sm" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th scope="col" class="pr-0">Shelfmark</th>
                <th scope="col" class="w-25">Summary</th>
                <th scope="col" class="w-25">Copyist</th>
                <th scope="col">Date</th>
                <th scope="col">Script</th>
            </tr>
        </thead>
        <tbody>
            <f:for each="{files -> fl:filter(extensions:'xml')}" as="file" iteration="fileKey">
                <tr data-href="{f:uri.page(additionalParams:{manuscript:'{v:format.pregReplace(subject:\'{file.name}\', pattern:\'#((?i)\b\.xml\b)(?!.*\1)#\', replacement:\'\')}'})}">
                    <f:format.raw>
                        <xslt:transform source="fileadmin{file.identifier}" transformations="{0:{stylesheet: 'EXT:middle_turkic_project/Configuration/MSConvertors/manuscriptTable.xsl'}}" />
                    </f:format.raw>
                </tr>
            </f:for>
        </tbody>
    </table>
</f:section>

<f:section name="manuscriptContentSection">
    <div>
        <f:format.raw>
            <xslt:transform source="{manuscriptPath}/{manuscriptArgument}.xml" transformations="{0:{stylesheet: 'EXT:middle_turkic_project/Configuration/MSConvertors/manuscriptJumbotron.xsl'}}" />
        </f:format.raw>

        <ul class="nav nav-tabs" id="manuscriptTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link" id="Description-tab" data-toggle="tab" href="#description" role="tab" aria-controls="description" aria-selected="true">Description</a>
            </li>
            <li class="nav-item">
                <f:variable name="transcriptionExists">
                    <f:if condition="{v:media.exists(directory:'{manuscriptPath}/{manuscriptArgument}', then:'1', else:'0')}">
                        <f:variable name="fileCount">
                            <f:count><v:media.files path="{manuscriptPath}/{manuscriptArgument}" extensionList="xml" /></f:count>    
                        </f:variable>
                        <f:if condition="{fileCount} > 0">
                            1
                        </f:if>
                    </f:if>                    
                </f:variable>
                {transcriptionExists -> v:format.trim() -> f:variable(name:'transcriptionExists')}
                <a class="nav-link active{f:if(condition:'{transcriptionExists}', else:' disabled')}" id="transcription-tab" data-toggle="tab" href="#transcription" role="tab" aria-controls="transcription" aria-selected="false">Transcription</a>
            </li>
            <li class="nav-item">
                <f:variable name="translationExists">
                    <f:if condition="{v:media.exists(directory:'{manuscriptPath}/{manuscriptArgument}.trl', then:'1', else:'0')}">
                        <f:variable name="fileCount">
                            <f:count><v:media.files path="{manuscriptPath}/{manuscriptArgument}.trl" extensionList="xml" /></f:count>    
                        </f:variable>
                        <f:if condition="{fileCount} > 0">
                            1
                        </f:if>
                    </f:if>                    
                </f:variable>
                {translationExists -> v:format.trim() -> f:variable(name:'translationExists')}
                <a class="nav-link{f:if(condition:'{translationExists}', else:' disabled')}" id="translation-tab" data-toggle="tab" href="#translation" role="tab" aria-controls="translation" aria-selected="false">Translation</a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" id="parallel-tab" data-toggle="tab" href="#parallel" role="tab" aria-controls="parallel" aria-selected="false">Parallel</a>
            </li>
        </ul>
        <div class="tab-content mt-4 ml-3" id="manuscriptTabsContent">
            <div class="tab-pane fade" id="description" role="tabpanel" aria-labelledby="description-tab">
                <f:format.raw>{manuscriptDescription}</f:format.raw>
            </div>
            <div class="tab-pane fade active show" id="transcription" role="tabpanel" aria-labelledby="transcription-tab">
                <f:render section="manuscriptNavBar" arguments="{_all}" />
                <div class="mt-3 px-2 loader">Loading<span class="d-inline-block ml-4 dot-pulse"></span></div>
                <div id="msTranscriptContent" class="mt-3 px-2" data-msnav="{manuscriptNav}" data-msname="{manuscriptArgument}"></div>
            </div>
            <div class="tab-pane fade" id="translation" role="tabpanel" aria-labelledby="translation-tab">
                <f:render section="manuscriptNavBar" arguments="{_all}" />
                <div class="mt-3 px-2 loader">Loading<span class="d-inline-block ml-4 dot-pulse"></span></div>
                <div id="msTranslationContent" class="mt-4 px-2" data-msnav="{manuscriptNav}" data-msname="{manuscriptArgument}"></div>
            </div>
            <div class="tab-pane fade" id="parallel" role="tabpanel" aria-labelledby="parallel-tab">...</div>
        </div>
    </div>
</f:section>

<f:section name="manuscriptNavBar">
    <div>
        <f:format.raw>
            <xslt:transform source="{manuscriptPath}/{manuscriptArgument}.xml" transformations="{0:{stylesheet: 'EXT:middle_turkic_project/Configuration/MSConvertors/manuscriptNavigationBar.xsl'}}" />
        </f:format.raw>
    </div>
</f:section>